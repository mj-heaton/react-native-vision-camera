name: Build & Release VisionCamera Fork

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  android-example:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: oven-sh/setup-bun@v2

      - name: Install workspace deps
        run: bun install

      - name: Restore Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-with-fps-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-with-fps-gradle-

      - name: Build Android example (debug + release)
        run: |
          cd example/android
          ./gradlew assembleDebug --no-daemon --build-cache
          ./gradlew assembleRelease --no-daemon --build-cache

      - name: Stop Gradle Daemon
        run: cd example/android && ./gradlew --stop

  android-example-no-frame-processors:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: oven-sh/setup-bun@v2

      - name: Install workspace deps
        run: bun install

      - name: Remove optional Frame Processor deps
        run: |
          bun remove react-native-worklets-core @shopify/react-native-skia react-native-reanimated --cwd example
          bun remove react-native-worklets-core @shopify/react-native-skia react-native-reanimated

      - name: Restore Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-without-fps-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-without-fps-gradle-

      - name: Build Android example without Frame Processors
        run: |
          cd example/android
          ./gradlew assembleDebug --no-daemon --build-cache

      - name: Stop Gradle Daemon
        run: cd example/android && ./gradlew --stop

  ios-example:
    runs-on: macos-latest
    env:
      REANIMATED_DISABLE_VERSION_CHECK: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install workspace deps
        run: bun install

      - name: Restore buildcache
        uses: mikehardy/buildcache-action@v2
        continue-on-error: true

      - name: Setup Ruby (bundle)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.2
          bundler-cache: true
          working-directory: example/ios

      - name: Restore Pods cache
        uses: actions/cache@v4
        with:
          path: example/ios/Pods
          key: ${{ runner.os }}-with-fps-pods-${{ hashFiles('example/ios/Podfile.lock', 'example/ios/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-with-fps-pods-

      - name: Install Pods
        working-directory: example/ios
        run: pod install

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build iOS example app
        working-directory: example/ios
        run: |
          set -o pipefail && xcodebuild \
            CC=clang CPLUSPLUS=clang++ LD=clang LDPLUSPLUS=clang++ \
            -derivedDataPath build -UseModernBuildSystem=YES \
            -workspace VisionCameraExample.xcworkspace \
            -scheme VisionCameraExample \
            -sdk iphonesimulator \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            build \
            CODE_SIGNING_ALLOWED=NO | xcpretty

  ios-example-no-frame-processors:
    runs-on: macos-latest
    env:
      REANIMATED_DISABLE_VERSION_CHECK: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install workspace deps
        run: bun install

      - name: Remove optional Frame Processor deps
        run: |
          bun remove react-native-worklets-core @shopify/react-native-skia react-native-reanimated --cwd example
          bun remove react-native-worklets-core @shopify/react-native-skia react-native-reanimated --cwd package

      - name: Restore buildcache
        uses: mikehardy/buildcache-action@v2
        continue-on-error: true

      - name: Setup Ruby (bundle)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.2
          bundler-cache: true
          working-directory: example/ios

      - name: Restore Pods cache
        uses: actions/cache@v4
        with:
          path: example/ios/Pods
          key: ${{ runner.os }}-without-fps-pods-${{ hashFiles('example/ios/Podfile.lock', 'example/ios/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-without-fps-pods-

      - name: Install Pods
        working-directory: example/ios
        run: pod install

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build iOS example app without Frame Processors
        working-directory: example/ios
        run: |
          set -o pipefail && xcodebuild \
            CC=clang CPLUSPLUS=clang++ LD=clang LDPLUSPLUS=clang++ \
            -derivedDataPath build -UseModernBuildSystem=YES \
            -workspace VisionCameraExample.xcworkspace \
            -scheme VisionCameraExample \
            -sdk iphonesimulator \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            build \
            CODE_SIGNING_ALLOWED=NO | xcpretty

  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---- Isolate the package so npm doesn't see other workspaces (docs/) ----
      - name: Prepare isolated build dir
        run: |
          rm -rf buildpkg
          mkdir -p buildpkg
          rsync -a package/ buildpkg/ --exclude node_modules --exclude dist --exclude lib

      - name: Install deps (isolated)
        working-directory: buildpkg
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        working-directory: buildpkg
        run: npm run build

      - name: Verify plugin output exists
        run: |
          test -f buildpkg/app.plugin.js || (echo "Missing app.plugin.js" && exit 1)
          test -f buildpkg/lib/commonjs/expo-plugin/withVisionCamera.js || \
            (echo "❌ Missing compiled plugin at lib/commonjs/expo-plugin/withVisionCamera.js" && exit 1)

      - name: Pack tarball (ignore pre/postpack scripts)
        id: pack
        working-directory: buildpkg
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          TARBALL=$(npm pack --silent --ignore-scripts)
          echo "TARBALL=$TARBALL" >> $GITHUB_ENV
          mv "$TARBALL" "../react-native-vision-camera-${PKG_VERSION}.tgz"

      - name: Generate checksum + verify files
        run: |
          ASSET_NAME="react-native-vision-camera-${PKG_VERSION}.tgz"
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV
          test -f "$ASSET_NAME" || (echo "❌ Missing $ASSET_NAME" && ls -la && exit 1)
          shasum -a 256 "$ASSET_NAME" > "${ASSET_NAME}.sha256"
          echo "Will upload:"
          ls -lh "$ASSET_NAME" "${ASSET_NAME}.sha256"

      # ---------- Tagged release (vX.Y.Z) ----------
      - name: Create GitHub Release for tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        env:
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          overwrite: true                 # <— allow re-runs to replace assets
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256

      # ---------- Rolling prerelease for main ----------
      - name: Create/Update prerelease for main
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        env:
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          tag_name: latest-main
          name: Latest main
          draft: false
          prerelease: true
          generate_release_notes: false
          overwrite: true                 # <— update assets on every push to main
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256
