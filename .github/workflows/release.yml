name: Build & Release VisionCamera Fork

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  android-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install workspace deps
        run: npm install --legacy-peer-deps

      - name: Build Android artifacts
        working-directory: package/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease --stacktrace

  ios-check:
    runs-on: macos-latest
    env:
      REANIMATED_DISABLE_VERSION_CHECK: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install workspace deps
        run: npm install --legacy-peer-deps

      - name: Install example pods
        working-directory: example/ios
        run: pod install

      - name: Build example app (exercises VisionCamera pod)
        working-directory: example/ios
        run: |
          xcodebuild \
            -workspace VisionCameraExample.xcworkspace \
            -scheme VisionCameraExample \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            build

  build-and-release:
    runs-on: ubuntu-latest
    needs:
      - android-check
      - ios-check

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---- Isolate the package so npm doesn't see other workspaces (docs/) ----
      - name: Prepare isolated build dir
        run: |
          rm -rf buildpkg
          mkdir -p buildpkg
          rsync -a package/ buildpkg/ --exclude node_modules --exclude dist --exclude lib

      - name: Install deps (isolated)
        working-directory: buildpkg
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        working-directory: buildpkg
        run: npm run build

      - name: Verify plugin output exists
        run: |
          test -f buildpkg/app.plugin.js || (echo "Missing app.plugin.js" && exit 1)
          test -f buildpkg/lib/commonjs/expo-plugin/withVisionCamera.js || \
            (echo "❌ Missing compiled plugin at lib/commonjs/expo-plugin/withVisionCamera.js" && exit 1)

      - name: Pack tarball (ignore pre/postpack scripts)
        id: pack
        working-directory: buildpkg
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          TARBALL=$(npm pack --silent --ignore-scripts)
          echo "TARBALL=$TARBALL" >> $GITHUB_ENV
          mv "$TARBALL" "../react-native-vision-camera-${PKG_VERSION}.tgz"

      - name: Generate checksum + verify files
        run: |
          ASSET_NAME="react-native-vision-camera-${PKG_VERSION}.tgz"
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV
          test -f "$ASSET_NAME" || (echo "❌ Missing $ASSET_NAME" && ls -la && exit 1)
          shasum -a 256 "$ASSET_NAME" > "${ASSET_NAME}.sha256"
          echo "Will upload:"
          ls -lh "$ASSET_NAME" "${ASSET_NAME}.sha256"

      # ---------- Tagged release (vX.Y.Z) ----------
      - name: Create GitHub Release for tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        env:
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          overwrite: true                 # <— allow re-runs to replace assets
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256

      # ---------- Rolling prerelease for main ----------
      - name: Create/Update prerelease for main
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        env:
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          tag_name: latest-main
          name: Latest main
          draft: false
          prerelease: true
          generate_release_notes: false
          overwrite: true                 # <— update assets on every push to main
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256
