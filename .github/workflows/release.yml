name: Build & Release VisionCamera Fork

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---- isolate the package so npm doesn't see the monorepo workspaces ----
      - name: Prepare isolated build dir
        run: |
          rm -rf buildpkg
          mkdir -p buildpkg
          # copy package/* including dotfiles, but not node_modules
          rsync -a package/ buildpkg/ --exclude node_modules --exclude dist --exclude lib

      - name: Install deps (isolated)
        working-directory: buildpkg
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        working-directory: buildpkg
        run: npm run build

      - name: Verify plugin output exists
        run: |
          test -f buildpkg/app.plugin.js || (echo "Missing app.plugin.js" && exit 1)
          test -f buildpkg/lib/commonjs/expo-plugin/withVisionCamera.js || \
            (echo "âŒ Missing compiled plugin at lib/commonjs/expo-plugin/withVisionCamera.js" && exit 1)

      - name: Pack tarball (ignore pre/postpack scripts)
        working-directory: buildpkg
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          # avoid monorepo prepack script that copies ../README.md
          TARBALL=$(npm pack --silent --ignore-scripts)
          echo "TARBALL=$TARBALL" >> $GITHUB_ENV
          mv "$TARBALL" "../react-native-vision-camera-${PKG_VERSION}.tgz"

      - name: Generate checksum
        run: |
          echo "ASSET_NAME=react-native-vision-camera-${PKG_VERSION}.tgz" >> $GITHUB_ENV
          shasum -a 256 "$ASSET_NAME" > "${ASSET_NAME}.sha256"

      # ---- Tagged release (vX.Y.Z) ----
      - name: Create GitHub Release for tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        env:
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256

      # ---- Rolling prerelease for main ----
      - name: Create/Update prerelease for main
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        env:
          ASSET_NAME: ${{ env.ASSET_NAME }}
        with:
          tag_name: latest-main
          name: Latest main
          draft: false
          prerelease: true
          generate_release_notes: false
          files: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256
